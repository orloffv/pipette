<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">

    <script src="http://documentcloud.github.com/underscore/underscore-min.js"></script>
    <script src="http://code.jquery.com/jquery-1.10.2.min.js"></script>
    <style>
    	#data {
      		border: 3px solid black;
      		border-collapse: collapse;
      	}
      	
      	#data td {
      		border: 3px solid black;
      		font-size: 25px;
      		padding: 15px;
      	}

      	#data.green, #data.green td{
  			border: 3px solid green;
      	}

      	#data.red, #data.red td{
  			border: 3px solid red;
      	}
    </style>
</head>
<body>
	<button id="generate">generate!</button>
	<select id="pipetts"></select>
	<input id="massa" value="0.02">
	<input id="massaMin" value="-0.0005">
	<input id="massaMax" value="0.0005">
	<input id="col5Default" value="2.5">
	<input id="col6Default" value="0.7">
	<div id="iterations"></div>
	<table id="data"></table>
  	<script>
  		var fixtures = {
			'er-200': [
				{
					massa: 0.02,
					col5Default: 2.5,
					col6Default: 0.7
				},
				{
					massa: 0.1,
					col5Default: 1,
					col6Default: 0.3
				},
				{
					massa: 0.2,
					col5Default: 0.6,
					col6Default: 0.2
				}
			],
			'er-1000': [
				{
					massa: 0.1,
					col5Default: 3,
					col6Default: 0.6,
				},
				{
					massa: 0.5,
					col5Default: 1,
					col6Default: 0.2,
				},
				{
					massa: 1,
					col5Default: 0.6,
					col6Default: 0.2,
				}
			],
			'er-5000': [
				{
					massa: 0.5,
					col5Default: 2.4,
					col6Default: 1.2,
				},
				{
					massa: 2.5,
					col5Default: 1.2,
					col6Default: 0.25,
				},
				{
					massa: 5,
					col5Default: 0.6,
					col6Default: 0.15,
				}
			],
			'biohit-1000': [
				{
					massa: 0.1,
					col5Default: 2,
					col6Default: 0.7,
				},
				{
					massa: 0.5,
					col5Default: 0.7,
					col6Default: 0.25,
				},
				{
					massa: 1,
					col5Default: 0.6,
					col6Default: 0.2,
				}
			],
			'er-8k': [
				{
					massa: 0.3,
					col5Default: 3,
					col6Default: 1,
				},
				{
					massa: 0.15,
					col5Default: 1,
					col6Default: 0.5,
				},
				{
					massa: 0.3,
					col5Default: 0.6,
					col6Default: 0.3,
				}
			],
			'er-12k': [
				{
					massa: 0.3,
					col5Default: 3,
					col6Default: 1,
				},
				{
					massa: 0.15,
					col5Default: 1,
					col6Default: 0.5,
				},
				{
					massa: 0.3,
					col5Default: 0.6,
					col6Default: 0.3,
				}
			],
			'biohit-8k': [
				{
					massa: 0.05,
					col5Default: 1.5,
					col6Default: 0.8,
				},
				{
					massa: 0.3,
					col5Default: 0.7,
					col6Default: 0.25,
				}
			],
			'kolor-8': [
				{
					massa: 0.05,
					col5Default: 4.6,
					col6Default: 1.5,
				},
				{
					massa: 0.3,
					col5Default: 1,
					col6Default: 0.3,
				}
			],
			'er-20': [
				{
					massa: 0.01,
					col5Default: 1.2,
					col6Default: 0.6,
				},
				{
					massa: 0.02,
					col5Default: 1,
					col6Default: 0.3,
				}
			],
		};

		var random = function(min, max) {
		    return Math.random() * (max - min) + min;
		};

		var mean = function(array) {
			return _.reduce(
				array, 
				function(memo, value) {
					return memo + value;
				}, 
				0) / 
			_.size(array);
		};

		var stdev = function(array) {
			var sum = _.reduce(
				array, 
				function(memo, value) {
					return memo + Math.pow(value - mean(array), 2);
				},
				0
			);

			return Math.sqrt((1 / (_.size(array)-1)) * sum);
		};

		function round(a, b) {
			b=b || 0;
		 	return Math.round(a*Math.pow(10,b))/Math.pow(10,b);
		};

		var check = function(col, defaultValue) {
			return col <= defaultValue && col >= (defaultValue * -1)
		};

		function getStatsPipets(massa, massaMin, massaMax, col5Default, col6Default) {
			var iteration = 0;
			do {
				iteration++;
			
				var col1 = [];
				
				for(var i = 1; i<=10; i++) {
					col1.push(round(random(massa + massaMin, massa + massaMax), 4));
				}

				var col2 = _.map(col1, function(value) {
					return value / 1.0033;
				});

				var col3 = mean(col2);

				var col4 = col3 - massa;
				var col5 = col4*100/massa;
				var col6 = stdev(col2) * 100 / col3;
			} while(!(check(col5, col5Default) && check(col6, col6Default)) && iteration < 100000)

			return {
				iteration: iteration,
				col1: col1,
				col2: col2,
				col3: round(col3, 4),
				col4: round(col4, 4),
				col5: round(col5, 2),
				col6: round(col6, 2),
				col5Check: check(col5, col5Default),
				col6Check: check(col6, col6Default)
			};
		};
	</script>
	<script>
		_.each(fixtures, function(pipetts, name) {
			var pipettHtml = '<optgroup label="' + name +'">';
			_.each(pipetts, function(pipett) {
				pipettHtml += '<option value="' + name + '_' + pipett.massa + '">' + pipett.massa + '</option>';
			});
			pipettHtml += '</optgroup>';
			$("#pipetts").append(pipettHtml);
		});

		$("#pipetts").change(function() {
			var pipetteValue = $("#pipetts").val();
			var pipetteValueArray = pipetteValue.split('_');
			var name = pipetteValueArray[0];
			var massa = pipetteValueArray[1];

			var pipett = _.find(fixtures[name], function(pipett) {
				return pipett.massa = massa;
			});

			$("#massa").val(pipett.massa);
			$("#col5Default").val(pipett.col5Default);
			$("#col6Default").val(pipett.col6Default);
		});

		$("#pipetts").trigger('change');

		$("#generate").click(function() {
			var data = getStatsPipets(
				parseFloat($("#massa").val()), 
				parseFloat($("#massaMin").val()), 
				parseFloat($("#massaMax").val()), 
				parseFloat($("#col5Default").val()), 
				parseFloat($("#col6Default").val())
			);
			var tr = [];
			_.each(data.col1, function(value, id) {
				tr[id] = [];
				tr[id][0] = value;
			});

			_.each(data.col2, function(value, id) {
				tr[id][1] = round(value, 4);
			});

			tr[0][2] = data.col3;
			tr[0][3] = data.col4;
			tr[0][4] = data.col5;
			tr[0][5] = data.col6;

			$("#data").html('');

			_.each(tr, function(object, line) {
				var lineData = '<tr>';
				lineData += '<td>' + (line + 1) + '</td>';
				lineData += '<td>' + object[0] + '</td>';
				lineData += '<td>' + object[1] + '</td>';

				if (line === 0) {
					lineData += '<td>' + object[2] + '</td>';
					//lineData += '<td>' + object[3] + '</td>';
					lineData += '<td>' + object[4] + '</td>';
					lineData += '<td>' + object[5] + '</td>';
				}

				lineData += '</tr>';

				$("#data").append(lineData);
			});		
			if (data.col5Check && data.col6Check) {
				$("#data").attr('class', 'green');
			} else {
				$("#data").attr('class', 'red');
			}

			$("#iterations").html('Найдено с ' + data.iteration);
		});
	</script>
</body>
</html>
